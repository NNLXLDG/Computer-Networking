# 第四章 网络层

## 4.1 TCP三次握手/四次挥手流程及状态转换

### 4.1.1 三次握手（连接建立）

- **流程**：
  1. **SYN**：客户端发送 SYN 段（`SEQ=x, SYN=1`），状态 `CLOSED → SYN_SENT`
  2. **SYN-ACK**：服务端回应 SYN-ACK（`SEQ=y, ACK=x+1, SYN=1, ACK=1`），状态 `LISTEN → SYN_RCVD`
  3. **ACK**：客户端确认（`ACK=y+1, ACK=1`），进入 `ESTABLISHED`；服务端收到后同样进入 `ESTABLISHED`

- **关键点**：
  - **序列号作用**：防止历史报文干扰（如旧SYN被误认，因序列号不匹配被丢弃）
  - **状态转换**：
    ```
    客户端: CLOSED → SYN_SENT → ESTABLISHED
    服务端: LISTEN → SYN_RCVD → ESTABLISHED
    ```

### 4.1.2 四次挥手（连接关闭）

- **流程**：
  1. **FIN**：主动方发送 FIN（`SEQ=u, FIN=1`），状态 `ESTABLISHED → FIN_WAIT_1`
  2. **ACK**：被动方确认（`ACK=u+1`），状态 `ESTABLISHED → CLOSE_WAIT`；主动方状态 `FIN_WAIT_1 → FIN_WAIT_2`
  3. **FIN**：被动方发送 FIN（`SEQ=v, FIN=1`），状态 `CLOSE_WAIT → LAST_ACK`
  4. **ACK**：主动方确认（`ACK=v+1`），进入 `TIME_WAIT`（等待2×MSL）；被动方关闭

- **关键点**：
  - **TIME_WAIT作用**：确保被动方收到最终ACK，并让网络中旧报文失效（MSL通常30秒）
  - **状态转换**：
    ```
    主动方: ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED
    被动方: ESTABLISHED → CLOSE_WAIT → LAST_ACK → CLOSED
    ```

## 4.2 滑动窗口与流量控制

### 4.2.1 滑动窗口机制

- **发送窗口（cwnd）**：允许连续发送但未确认的字节数（受拥塞控制调节）
- **接收窗口（rwnd）**：接收方缓冲区剩余空间（通过TCP头部`window`字段通告）
- **窗口滑动**：
  - 发送方收到ACK时，移动窗口左沿：`SendBase = ACK_num`
  - 接收方交付数据后更新rwnd：`rwnd = RcvBuffer - (LastByteRcvd - LastByteRead)`

### 4.2.2 流量控制原理

- **目的**：防止发送速率 > 接收方处理能力
- **零窗口处理**：
  - 当`rwnd=0`，发送方暂停发送并启动**持续计时器**（Persist Timer）
  - 定期发送1字节探测报文，获取最新rwnd

**对比项**：

| **机制**       | 拥塞控制                      | 流量控制                |
|----------------|-----------------------------|-------------------------|
| **控制对象**   | 网络全局资源（路由器队列）     | 接收方本地缓冲区        |
| **触发信号**   | 丢包、延迟增加                | `rwnd=0`               |
| **调节参数**   | cwnd（发送窗口）             | 限制发送量≤rwnd         |

## 4.3 拥塞控制算法

### 4.3.1 慢启动（Slow Start）

- **触发**：连接建立或超时丢包时
- **规则**：
  - 初始`cwnd = 1 MSS`
  - 每收到一个ACK：`cwnd += 1 MSS` → **每RTT翻倍**
  - 当`cwnd ≥ ssthresh`（默认65535字节）进入拥塞避免

### 4.3.2 拥塞避免（AIMD）

- **加性增大**：每RTT `cwnd += 1 MSS`（实际每ACK增`MSS×MSS/cwnd`）
- **乘性减小**：
  - **超时丢包**：`ssthresh = cwnd/2`, `cwnd = 1 MSS` → 重启慢启动
  - **3重复ACK**：`ssthresh = cwnd/2`, `cwnd = ssthresh + 3 MSS` → 进入快速恢复

### 4.3.3 快速恢复（Fast Recovery）

- 重传丢失段后，每收到重复ACK：`cwnd += 1 MSS`
- 收到新ACK：`cwnd = ssthresh` → 进入拥塞避免

**算法状态机**：
```
慢启动 → (cwnd≥ssthresh) → 拥塞避免
拥塞避免 → (超时) → 慢启动
拥塞避免 → (3 DupACK) → 快速恢复
快速恢复 → (新ACK) → 拥塞避免
```

## 4.4 关键问题详解

### 4.4.1 为何快速重传需3个重复ACK？

- **防误判**：网络乱序可能产生1-2个重复ACK，但连续3个极可能因丢包
- **效率权衡**：少于3个增加误判率；多于3个延迟重传，降低吞吐量
- **实验验证**：RFC 5681基于大量实验确定阈值为3

### 4.4.2 QUIC相比TCP的核心优势

| **特性**        | TCP                    | QUIC（基于UDP）         |
|-----------------|------------------------|-------------------------|
| **连接建立**    | 3次握手（1.5 RTT）     | 0/1 RTT（复用会话密钥） |
| **队头阻塞**    | 单流阻塞影响全连接      | 多独立流无阻塞          |
| **拥塞控制**    | 固定算法               | 可插拔（如BBR）         |
| **移动切换**    | IP变化需重建连接        | 连接ID不变，无缝切换    |
| **加密**        | 可选（TLS）            | 强制加密（TLS 1.3）     |

**应用场景**：HTTP/3使用QUIC，提升视频会议、移动端体验（如Google Meet）。

## 4.5 IP地址分配机制

### 4.5.1 DHCP协议（动态主机配置协议）

**工作流程**：
1. **发现阶段**：客户端广播`DHCP Discover`报文（源IP 0.0.0.0，目标IP 255.255.255.255）
2. **提供阶段**：服务器响应`DHCP Offer`（包含IP地址、子网掩码、租期）
3. **请求阶段**：客户端广播`DHCP Request`确认选择
4. **确认阶段**：服务器发送`DHCP ACK`完成分配

**关键技术点**：
- **租期管理**：客户端在租期过半时尝试续约（直接向原服务器发送Request）
- **分配参数**：除IP外，同时分配网关、DNS服务器地址
- **封装结构**：DHCP报文承载于UDP（客户端端口68，服务器端口67）

### 4.5.2 层次化地址分配

**CIDR（无类域间路由）**：
- **格式**：`IP地址/前缀长度`（如200.23.16.0/20）
- **聚合原理**：
  
  ```python
  # 8个连续/23子网聚合成一个/20路由
  200.23.16.0/23 → 11001000 00010111 00010000 00000000
  200.23.18.0/23 → 11001000 00010111 00010010 00000000
  聚合后：200.23.16.0/20 （匹配高20位）
  ```
- **例外处理**：当子网移动时添加更具体路由（如200.23.18.0/23单独通告）

## 4.6 网络地址转换（NAT）

### 4.6.1 核心机制

**转换表示例**：

| WAN端地址          | LAN端地址       |
|---------------------|----------------|
| 138.76.29.7:5001    | 10.0.0.1:3345  |
| 138.76.29.7:5002    | 10.0.0.2:4567  |

**工作流程**：
1. 内网主机发送数据包（源IP: 10.0.0.1:3345）
2. NAT路由器替换源地址为公网IP:端口（138.76.29.7:5001）
3. 响应包目标地址被NAT还原为内网地址

### 4.6.2 穿透解决方案

- **STUN协议**：通过公网服务器发现NAT映射的公网地址
- **端口转发**：手动配置NAT映射规则（如将公网端口80映射到内网Web服务器）

## 4.7 IPv6协议

### 4.7.1 首部优化（对比IPv4）

| 特性         | IPv4                  | IPv6                  |
|--------------|-----------------------|-----------------------|
| **首部长度** | 20字节+选项           | 固定40字节            |
| **分片处理** | 路由器可分片           | 仅端点分片            |
| **校验和**   | 有                    | 无（依赖上层校验）     |
| **地址长度** | 32位（约42亿）         | 128位（3.4×10³⁸）      |

### 4.7.2 过渡技术

**双栈与隧道**：
- **双栈**：路由器同时支持IPv4和IPv6
- **隧道**：IPv6数据包封装在IPv4包中传输
- **转换**：NAT64实现IPv6与IPv4网络互通

## 4.8 通用转发与SDN

### 4.8.1 OpenFlow流表示例

**防火墙规则**：
```
match {
  ingress_port: 任意
  ip_src: 128.119.1.1
  ip_proto: TCP
  tcp_dst: 22
}
action: DROP
```

**负载均衡**：
```
match {
  ip_dst: 10.2.0.0/16
}
action: 
  - 50%概率转发至端口3（主机10.2.0.3）
  - 50%概率转发至端口4（主机10.2.0.4）
```

## 4.9 中间件（Middlebox）

### 4.9.1 类型与功能

| 类型         | 功能描述                     | 部署位置               |
|--------------|------------------------------|------------------------|
| **NAT**      | 地址转换                     | 家庭/企业网关          |
| **防火墙**   | 流量过滤（基于IP/端口）      | 网络边界               |
| **负载均衡器**| 分流至多台服务器             | 数据中心入口           |
| **缓存代理** | 内容加速                     | CDN边缘节点           |

## 4.10 互联网架构原则

### 4.10.1 端到端原则（End-to-End Argument）

**核心思想**：
> 网络核心保持简单，复杂功能应在终端实现（如TCP重传机制）

**现代演变**：
- **SDN/NFV**：将智能集中到控制器，数据平面保持简单
- **边缘计算**：在靠近用户的位置部署计算能力（如CDN）

## 附录

### 高频考点解析

1. **CIDR路由聚合计算**  
   - 给定多个子网（如200.23.16.0/24 ~ 200.23.23.0/24），计算聚合后前缀
   - 关键：寻找共同最高位（此例共同前缀20位 → 200.23.16.0/20）

2. **NAT转换表分析**  
   - 根据通信过程填写NAT表
   - 注意：端口号动态分配，同一内网IP不同连接端口不同

3. **IPv6隧道封装**  
   - 计算封装后数据包长度：IPv6基础头40B + IPv4头20B + 原始载荷
   - 理解隧道端点行为：封装/解封装操作

4. **OpenFlow匹配规则**  
   - 多字段组合匹配（如阻止特定IP访问SSH服务）
   - 动作类型：转发、丢弃、修改、送控制器

### 高频考点总结

1. **三次握手**：序列号随机化、SYN洪泛攻击防护（SYN Cookie）
2. **流量控制**：零窗口探测报文结构（SEQ=`LastByteSent-1`）
3. **拥塞控制**：AIMD参数计算（如超时后`ssthresh`取值）
4. **QUIC**：连接迁移原理（Connection ID不变）

### 记忆口诀

> "SYN发，SYN-ACK回，ACK确认连接通；  
> FIN启，ACK应，FIN再发，ACK终。"
