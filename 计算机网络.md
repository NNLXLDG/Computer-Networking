# 第一章 计算机网络导论

## 1.1 互联网概述
### 1.1.1 互联网的组成要素
- 基础设施视角：
  - 数十亿互联的计算设备（主机/端系统）
  - 通信链路（光纤、铜缆、无线电、卫星）
  - 分组交换设备（路由器和交换机）
  - 由多个组织管理的网络集合

### 1.1.2 服务视角
- 为应用层服务提供基础设施：
  - Web、流媒体、视频会议、电子商务等
  - 提供分布式应用的编程接口（API）

### 1.1.3 互联网协议
- 定义：
  - 控制消息收发规则的集合
  - 规定消息格式、顺序和响应动作
- 常见协议示例：
  - HTTP, TCP, IP, WiFi, 4G/5G, Ethernet
- 标准化组织：
  - IETF（互联网工程任务组）
  - RFC（请求评论）文档体系

## 1.2 网络边缘

### 1.2.1 接入网络类型
- 住宅接入：
  - DSL（数字用户线）：利用电话线，24-52Mbps下行
  - HFC（混合光纤同轴）：40Mbps-1.2Gbps下行
- 企业接入：
  - 以太网（100Mbps-10Gbps）
  - WiFi（802.11标准）
- 移动接入：
  - 蜂窝网络（4G/5G）
  - WiFi热点

### 1.2.2 物理介质
- 有线介质：
  - 双绞线（Cat5/Cat6）
  - 同轴电缆
  - 光纤（10-100Gbps）
- 无线介质：
  - 无线电频谱（2.4GHz/5GHz）
  - 微波传输
  - 卫星通信

## 1.3 网络核心

### 1.3.1 分组交换
- 工作原理：
  - 存储转发机制
  - 统计复用共享带宽
- 关键参数：
  - 传输延迟 = 数据包大小/链路速率（L/R）
  - 排队与丢包现象

### 1.3.2 电路交换
- 特点：
  - 专用端到端连接
  - 频分复用（FDM）和时分复用（TDM）
  - 资源独占，无带宽竞争

### 1.3.3 交换技术对比
| 特性        | 分组交换          | 电路交换        |
|-----------|---------------|-------------|
| 资源分配      | 动态共享         | 静态预留       |
| 适合流量类型    | 突发数据         | 恒定流量       |
| 带宽利用率     | 高             | 低           |
| 服务质量保证    | 无             | 有           |

## 1.4 互联网结构

### 1.4.1 分层架构
1. 接入层：终端用户网络（家庭/企业）
2. 区域ISP：本地服务提供商
3. 国家ISP：骨干网络运营商
4. 内容提供商网络（Google等自建网络）

### 1.4.2 互联机制
- IXP（互联网交换中心）：
  - 实现不同ISP之间的对等互联
- 对等连接协议：
  - 商业协议规范网络互连

## 1.5 网络性能

### 1.5.1 关键指标
- 延迟组成：
  - 传输延迟
  - 传播延迟
  - 处理延迟
  - 排队延迟
- 吞吐量：
  - 瓶颈链路决定端到端吞吐量
- 丢包率：
  - 缓冲区溢出导致数据丢失


### 1.5.2 数据包延迟类型
- **处理延迟**（<1μs）：
  - 错误检查
  - 路由决策
- **排队延迟**：
  - 取决于路由器拥塞程度
  - 流量强度=La/R（a:到达率，L:包长，R:链路速率）
    - La/R→1时延迟显著增大
    - La/R>1时出现无限延迟（理论模型）
- **传输延迟**：
  - 计算公式：d<sub>trans</sub> = L/R
  - L: 数据包长度(bit)，R: 链路速率(bps)
- **传播延迟**：
  - 计算公式：d<sub>prop</sub> = d/s
  - d: 物理距离，s: 传播速度(≈2×10<sup>8</sup>m/s)

### 1.5.3 延迟类比模型
- **车队过收费站模型**：
  - 收费站服务时间对应传输延迟
  - 公路行驶时间对应传播延迟
  - 关键启示：传输延迟与数据包长度正相关，传播延迟与物理距离正相关

### 1.5.4 真实网络延迟测量
- **Traceroute工具**：
  - 通过TTL递增探测路径
  - 显示路径中每个节点的三次RTT值
  - 示例结果分析：
    ```bash
    8  62.40.103.253  104ms  # 跨洋链路延迟突增
    19 fantasia.eurecom.fr 132ms  # 端到端总延迟
    ```

## 1.6 网络安全基础

### 1.6.1 主要攻击类型
| 攻击类型        | 原理描述                     | 防御措施                 |
|---------------|--------------------------|----------------------|
| 数据包嗅探        | 利用共享介质截取明文数据            | 加密传输（HTTPS, VPN）      |
| IP地址欺骗       | 伪造源地址发起攻击               | 入口过滤（RFC 2827）        |
| DDoS攻击       | 僵尸网络淹没目标资源              | 流量清洗、黑洞路由            |
| 中间人攻击        | 劫持会话窃取信息                | 数字证书认证、双向认证           |

### 1.6.2 安全防御体系
1. **认证机制**：
   - SIM卡物理认证（蜂窝网络）
   - 数字证书（TLS/SSL）
2. **加密传输**：
   - 对称加密（AES）
   - 非对称加密（RSA）
3. **完整性保护**：
   - HMAC哈希校验
   - 数字签名（ECDSA）
4. **访问控制**：
   - 防火墙状态检测
   - ACL访问控制列表

## 1.7 协议分层模型
- 各层独立发展
- 下层为上层提供服务
- 协议栈实例：
  - TCP/IP五层模型（物理层→应用层）


### 1.7.1 TCP/IP五层模型
| 层级       | 协议示例                  | 数据单元     | 关键功能               |
|----------|-----------------------|----------|--------------------|
| 应用层      | HTTP, DNS, SMTP       | 消息/报文    | 实现具体应用服务           |
| 传输层      | TCP, UDP              | 段        | 端到端通信质量控制          |
| 网络层      | IP, ICMP              | 数据报      | 路由选择与逻辑寻址          |
| 数据链路层    | Ethernet, 802.11      | 帧        | 介质访问控制与物理地址        |
| 物理层      | RJ45, 无线电频谱          | 比特流      | 信号编码与物理传输          |


### 1.7.2 封装过程图解
1. **应用层**：原始数据（如HTTP请求）
2. **传输层**：添加TCP头 → 段（源/目的端口，序列号）
3. **网络层**：添加IP头 → 数据报（源/目的IP，TTL）
4. **链路层**：添加以太网头 → 帧（MAC地址，FCS校验）
5. **物理层**：转换为电信号/光信号

```
[HTTP数据]
↓ +TCP头 → [TCP段]
↓ +IP头  → [IP数据报] 
↓ +以太网头 → [以太网帧]
↓ 比特流传输
```

## 1.8 互联网发展简史

### 1.8.1 关键发展阶段
- **1969**：ARPANET诞生（4节点）
- **1974**：TCP/IP架构提出（Cerf & Kahn）
- **1983**：TCP/IP成为标准协议
- **1991**：WWW正式发布（Tim Berners-Lee）
- **1994**：Netscape浏览器推动Web普及
- **2005+**：移动互联网时代（4G/5G, 智能手机）
- **2010+**：云计算与SDN革命

### 1.8.2 重要技术里程碑
- **1988**：TCP拥塞控制算法
- **1998**：Google搜索引擎诞生
- **2004**：Facebook开启社交网络时代
- **2006**：AWS推出云计算服务
- **2007**：iPhone重新定义移动互联网
- **2012**：软件定义网络（SDN）商用化

## 附录：重点概念对比

### 延迟类型对比
| 延迟类型   | 影响因素               | 典型值范围        |
|--------|--------------------|--------------|
| 传输延迟 | 数据包大小、链路带宽       | 1μs-100ms    |
| 传播延迟 | 物理距离、介质传播速度      | 1ms-300ms    |
| 处理延迟 | 路由器处理能力          | <1μs         |
| 排队延迟 | 流量强度、缓冲区大小       | 0-数秒        |

### 安全攻击对比
| 攻击类型 | 攻击层级    | 检测难度 | 危害程度 |
|------|---------|------|------|
| 嗅探   | 链路层     | 高    | 中    |
| DDoS | 网络层     | 中    | 高    |
| XSS  | 应用层     | 低    | 高    |
| MITM | 传输层     | 高    | 极高   |


## 第二章 应用层


### 2.1 应用层核心概念

#### 2.1.1 网络应用架构模式
- **客户端-服务器模型**：
  - **服务器**：常驻主机，固定IP，部署于数据中心（支持横向扩展）。
  - **客户端**：间歇性连接，动态IP，不直接互连（如HTTP、FTP）。
- **P2P架构**：
  - 无中心服务器，节点互为客户端/服务器（如BitTorrent）。
  - 优点：自扩展性（节点增加提升服务能力）、抗单点故障。
  - 挑战：动态IP、连接不稳定、管理复杂度高。

#### 2.1.2 进程通信与套接字
- **进程标识**：由IP地址+端口号唯一确定（如HTTP-80、SMTP-25）。
- **套接字（Socket）**：
  - 进程间通信的“门”，操作系统控制底层传输，开发者控制应用逻辑。
  - 类比：发送进程将消息“推出门”，传输层负责跨网络投递到接收进程的“门”。

#### 2.1.3 应用层协议设计要素
- **消息类型**：请求/响应（如HTTP GET/200 OK）。
- **消息格式**：
  - 语法：字段定义与分隔符（如HTTP头部的`\r\n`）。
  - 语义：字段含义（如`Content-Type: text/html`）。
- **开放与私有协议**：
  - 开放协议（RFC标准）：HTTP、SMTP（支持互操作性）。
  - 私有协议：Skype、Zoom（封闭实现）。

---

### 2.2 HTTP协议深度解析

#### 2.2.1 连接管理
- **非持久连接（HTTP 1.0）**：
  - 每个对象需单独建立TCP连接，延迟公式：`2RTT + 传输时间`。
  - 缺点：高延迟（多次握手）、资源浪费（TCP连接开销）。
- **持久连接（HTTP 1.1）**：
  - 单TCP连接传输多个对象，支持流水线请求，减少RTT至1次。
  - 优势：降低延迟、节省带宽。

#### 2.2.2 HTTP消息结构
- **请求消息**：
  ```http
  GET /index.html HTTP/1.1
  Host: www.example.com
  User-Agent: Mozilla/5.0
  Accept-Language: en-US
  ```
  - 方法：GET（获取资源）、POST（提交数据）、HEAD（获取头部）、PUT（上传文件）。
- **响应消息**：
  ```http
  HTTP/1.1 200 OK
  Content-Type: text/html
  Content-Length: 1234
  ```
  - 状态码：200（成功）、301（永久重定向）、404（未找到）、500（服务器错误）。

#### 2.2.3 状态管理：Cookie机制
- **工作原理**：
  1. 服务器通过`Set-Cookie`头部下发唯一标识。
  2. 客户端后续请求携带`Cookie`头部，服务器识别用户状态。
- **应用场景**：
  - 会话管理（如登录状态）、个性化推荐、购物车。
- **隐私争议**：
  - 第一方Cookie：站点自身使用（如用户偏好）。
  - 第三方Cookie：跨站跟踪（如广告联盟），Chrome 2023后默认禁用。

#### 2.2.4 性能优化：Web缓存
- **缓存工作流程**：
  1. 客户端请求先发送至缓存服务器。
  2. 命中缓存则直接返回，否则向源服务器请求并缓存。
- **优势**：
  - 降低延迟（缓存靠近客户端）。
  - 减少带宽消耗（如企业节省出口流量）。
- **条件GET**：
  - 客户端发送`If-Modified-Since`头部，若资源未修改，服务器返回`304 Not Modified`，避免重复传输。

#### 2.2.5 HTTP演进：HTTP/2与HTTP/3
- **HTTP/2核心改进**：
  - 多路复用：帧（Frame）化传输，解决队头阻塞（HOL Blocking）。
  - 头部压缩：HPACK算法减少冗余。
  - 服务器推送：主动推送关联资源（如CSS/JS）。
- **HTTP/3革新**：
  - 基于QUIC协议（UDP+ TLS 1.3），实现0-RTT连接、独立流控。
  - 解决TCP重传阻塞问题，提升移动网络性能。

---

### 2.3 电子邮件系统

#### 2.3.1 核心组件
- **用户代理（UA）**：Outlook、Gmail客户端，负责邮件编辑、发送、接收。
- **邮件服务器**：存储用户邮箱，使用SMTP协议传输邮件。
- **协议栈**：SMTP（发件）、IMAP/POP3（收件）、HTTP（Web邮箱）。

#### 2.3.2 SMTP协议详解
- **工作流程**：
  1. 客户端（发送服务器）通过TCP 25端口连接接收服务器。
  2. 命令交互：`HELO`握手 → `MAIL FROM`/`RCPT TO`指定收发方 → `DATA`传输内容。
- **特点**：
  - 推模式（Push），使用7-bit ASCII编码，支持持久连接。
  - 与HTTP对比：无状态 vs 有状态（SMTP需维护会话）。

#### 2.3.3 邮件访问协议
- **POP3**：简单下载删除模型，适合单设备访问。
- **IMAP**：在服务器管理文件夹，支持多设备同步（如已读状态）。
- **WebMail**：基于HTTP的图形界面（如Gmail），底层仍依赖SMTP/IMAP。

---

### 2.4 网络安全与性能（补充）

#### 2.4.1 TLS加密
- **作用**：为TCP连接提供加密（防窃听）、完整性校验（防篡改）、身份认证。
- **应用**：HTTPS = HTTP + TLS，端口443，使用SNI扩展支持多域名。

#### 2.4.2 内容分发网络（CDN）
- **原理**：将热门资源缓存至边缘节点，就近服务用户。
- **类型**：拉取式（按需缓存）、推送式（预分发）。

---

### 附录：关键协议对比表

| 协议    | 端口  | 传输层 | 特性                               | 典型应用         |
|---------|-------|--------|------------------------------------|------------------|
| HTTP    | 80    | TCP    | 无状态、请求-响应                 | 网页浏览         |
| HTTPS   | 443   | TCP    | HTTP + TLS加密                     | 安全交易         |
| SMTP    | 25    | TCP    | 文本推模式、持久连接              | 邮件发送         |
| IMAP    | 143   | TCP    | 服务器管理邮件、多设备同步        | 邮件接收（多端） |
| DNS     | 53    | UDP/TCP| 域名解析、缓存机制                | 地址查询         |

---

#### 2.1 DNS：域名系统

##### 2.1.1 DNS核心功能
- **域名解析**：将主机名（如`www.example.com`）转换为IP地址（如`192.0.2.1`）。
- **反向解析**：通过IP地址查询域名。
- **服务类型支持**：
  - **主机别名**：一个域名可映射多个别名（如`mail.example.com`作为`example.com`的邮件服务器）。
  - **负载均衡**：一个域名对应多个IP地址，实现流量分发。
  - **邮件服务器定位**：通过MX记录指定邮件服务器地址。

##### 2.1.2 DNS层次化架构
- **根域名服务器**：全球13组逻辑根服务器（实际数百台物理服务器），负责TLD服务器地址查询。
- **顶级域名（TLD）服务器**：管理`.com`、`.org`、`.edu`等通用顶级域及国家代码顶级域（如`.cn`）。
- **权威域名服务器**：存储特定域名的资源记录（如`example.com`的DNS服务器）。
- **本地DNS服务器**：由ISP或组织提供，缓存近期查询结果，减少根服务器负载。

##### 2.1.3 DNS查询类型
- **迭代查询**：
  - 本地DNS服务器依次向根、TLD、权威服务器查询。
  - 示例：`client → local DNS → root → .com TLD → example.com权威`。
- **递归查询**：
  - 本地DNS代理客户端完成所有查询步骤。
  - 对根和TLD服务器负载较大，较少使用。

##### 2.1.4 DNS资源记录类型
| 类型   | 描述                          | 示例                                 |
|--------|-------------------------------|--------------------------------------|
| A      | IPv4地址记录                  | `www.example.com → 192.0.2.1`       |
| AAAA   | IPv6地址记录                  | `www.example.com → 2001:db8::1`     |
| CNAME  | 别名记录                      | `mail.example.com → example.com`    |
| MX     | 邮件服务器记录                | `example.com → mail.example.com`    |
| NS     | 指定域名的权威服务器          | `example.com → ns1.example.com`     |
| TXT    | 文本信息（如SPF、DKIM验证）   | `"v=spf1 include:_spf.example.com"` |

##### 2.1.5 DNS安全与挑战
- **DDoS攻击**：针对根或TLD服务器的大流量攻击，通过本地缓存缓解。
- **DNS欺骗（缓存投毒）**：伪造DNS响应，引导用户至恶意IP。
- **DNSSEC**：通过数字签名验证数据来源，防止篡改（RFC 4033）。

---

#### 2.2 P2P网络与文件分发

##### 2.2.1 P2P架构特点
- **去中心化**：无固定服务器，节点互为客户端和服务器。
- **自扩展性**：节点加入提升系统整体服务能力。
- **动态性**：节点可随时加入/离开，IP地址可变。

##### 2.2.2 BitTorrent协议机制
- **核心组件**：
  - **种子文件（.torrent）**：包含Tracker URL和文件分块哈希。
  - **Tracker服务器**：协调节点列表，不参与数据传输。
  - **Swarm**：参与同一文件分发的节点集合。
- **分块传输策略**：
  - **最稀有优先（Rarest First）**：优先下载稀缺分块，提高系统冗余。
  - **Tit-for-Tat**：节点优先服务上传速率高的对等方。
  - **乐观疏通（Optimistic Unchoking）**：随机选择节点上传，防止资源垄断。

##### 2.2.3 P2P与C/S模型对比
| 指标         | 客户端-服务器模型               | P2P模型                              |
|--------------|---------------------------------|--------------------------------------|
| 扩展性       | 服务器带宽成为瓶颈              | 节点越多，分发能力越强                |
| 成本         | 服务器维护成本高                | 基础设施成本低                        |
| 可靠性       | 单点故障风险                    | 高冗余，抗节点失效                    |
| 适用场景     | 小规模、静态内容                | 大规模分发（如Linux镜像、视频）       |

---

#### 2.3 流媒体与内容分发网络（CDN）

##### 2.3.1 视频流技术基础
- **编码与压缩**：
  - **空间冗余**：单帧内相似区域压缩（如JPEG）。
  - **时间冗余**：连续帧间差异编码（如MPEG）。
- **传输协议**：
  - **DASH（Dynamic Adaptive Streaming）**：客户端动态选择视频质量，基于带宽变化调整。
  - **HLS（HTTP Live Streaming）**：苹果公司标准，将视频切分为TS分片，通过M3U8索引。

##### 2.3.2 CDN架构与策略
- **内容缓存策略**：
  - **拉取式（Pull）**：按需缓存，适合长尾内容。
  - **推送式（Push）**：预分发热门内容至边缘节点。
- **节点部署模式**：
  - **Enter Deep**：深入ISP网络（如Akamai），减少延迟。
  - **Bring Home**：在互联网交换点（IXP）部署（如Cloudflare）。

##### 2.3.3 Netflix案例
- **Open Connect CDN**：
  - 自建CDN节点，与ISP合作部署。
  - 用户请求通过ISP本地节点直接获取内容，降低骨干网压力。
- **视频分发流程**：
  1. 用户请求视频，DNS返回最近的CDN节点。
  2. 客户端下载Manifest文件，选择最佳质量分片。
  3. 分片通过HTTP范围请求（Range Request）传输。

---

#### 2.4 Socket编程基础

##### 2.4.1 UDP与TCP对比
| 特性               | UDP                                  | TCP                                  |
|--------------------|--------------------------------------|--------------------------------------|
| 连接方式           | 无连接                               | 面向连接                             |
| 可靠性             | 不保证顺序和到达                     | 可靠传输，有序                       |
| 头部开销           | 8字节                                | 20字节                               |
| 适用场景           | 实时音视频、DNS查询                  | 文件传输、网页浏览                   |

##### 2.4.2 关键API函数
- **UDP通信流程**：
  ```c
  // 服务器端
  socket(AF_INET, SOCK_DGRAM, 0);
  bind(sock, (struct sockaddr*)&addr, sizeof(addr));
  recvfrom(sock, buffer, len, 0, &client_addr, &addr_len);
  sendto(sock, data, len, 0, &client_addr, addr_len);

  // 客户端
  sendto(sock, data, len, 0, &server_addr, sizeof(server_addr));
  recvfrom(sock, buffer, len, 0, NULL, NULL);
  ```

- **TCP通信流程**：
  ```c
  // 服务器端
  listen(sock, backlog);
  accept(sock, &client_addr, &addr_len);  // 阻塞等待连接
  send(new_sock, data, len, 0);
  recv(new_sock, buffer, len, 0);

  // 客户端
  connect(sock, &server_addr, sizeof(server_addr));
  send(sock, data, len, 0);
  recv(sock, buffer, len, 0);
  ```

##### 2.4.3 地址结构体
- **IPv4地址表示**：
  ```c
  struct sockaddr_in {
      sa_family_t    sin_family;   // AF_INET
      in_port_t      sin_port;     // 端口号（网络字节序）
      struct in_addr sin_addr;     // IPv4地址
  };

  struct in_addr {
      uint32_t s_addr;             // 32位IP地址（网络字节序）
  };
  ```

---

#### 附录：关键协议端口号速查表

| 协议   | 端口号 | 传输层协议 | 用途               |
|--------|--------|------------|--------------------|
| HTTP   | 80     | TCP        | 网页传输           |
| HTTPS  | 443    | TCP        | 加密HTTP           |
| DNS    | 53     | UDP/TCP    | 域名解析           |
| SMTP   | 25     | TCP        | 邮件发送           |
| IMAP   | 143    | TCP        | 邮件管理           |
| SSH    | 22     | TCP        | 安全远程登录       |
| FTP    | 21     | TCP        | 文件传输控制       |

注：Socket编程示例中的错误处理（如`recv`返回-1时检查`errno`）需结合具体实现补充。建议通过Wireshark抓包分析DNS查询、HTTP请求等实际流量，加深协议理解。

























