# 第三章 传输层

## 3.1 传输层核心功能

### 3.1.1 传输层与网络层的关系

- **网络层**：负责主机到主机的通信（如IP协议）。
- **传输层**：负责进程到进程的通信（如TCP/UDP），通过端口号标识应用进程。
- **核心服务**：
  - **多路复用/分解**：将多个应用进程的数据通过不同端口区分。
  - **可靠性**：确保数据完整、有序传输（TCP）。
  - **流量控制**：防止发送方压垮接收方（TCP滑动窗口）。
  - **拥塞控制**：避免网络过载（TCP拥塞控制算法）。

## 3.2 多路复用与分解

### 3.2.1 多路复用（Multiplexing）

- **定义**：将多个应用进程的数据合并到单一网络层数据流中。
- **实现方式**：通过添加传输层头部（含端口号）区分不同应用。

### 3.2.2 分解（Demultiplexing）

- **定义**：将接收到的数据分发到正确的目标应用进程。
- **关键字段**：
  - **UDP**：仅使用目标端口号进行分解。
  - **TCP**：使用四元组（源IP、源端口、目标IP、目标端口）进行分解。

| 协议 | 分解依据                     | 特点                     |
|------|------------------------------|--------------------------|
| UDP  | 目标端口号                   | 无连接，同一端口接收所有源数据 |
| TCP  | 源IP、源端口、目标IP、目标端口 | 面向连接，每个连接独立处理 |

## 3.3 无连接传输：UDP

### 3.3.1 UDP核心特点

- **无连接**：无需建立连接，直接发送数据。
- **不可靠性**：不保证数据到达、顺序或完整性。
- **高效性**：头部开销小（8字节），无拥塞控制，适合实时应用。

### 3.3.2 UDP段格式

```plaintext
 0               16              31
+----------------+----------------+
|   源端口号     |   目标端口号    |
+----------------+----------------+
|     长度       |    校验和       |
+----------------+----------------+
|           应用数据（载荷）       |
+----------------------------------+
```
- **长度**：UDP段总长度（包括头部）。
- **校验和**：检测数据传输中的错误（16位反码和）。

### 3.3.3 UDP适用场景

- **实时流媒体**：如视频会议（容忍丢包，低延迟优先）。
- **DNS查询**：短小请求/响应，无需连接建立。
- **SNMP监控**：周期性状态报告，偶发丢包可接受。
- **HTTP/3**：基于UDP实现可靠传输，优化Web性能。

## 3.4 可靠数据传输原理

### 3.4.1 基本概念

- **可靠信道抽象**：数据不丢失、不重复、按序到达。
- **实现挑战**：网络层不可靠（丢包、乱序、错误）。

### 3.4.2 可靠数据传输协议（rdt）

1. **rdt1.0**：理想信道（无错误）。
2. **rdt2.0**：引入错误检测（校验和）与确认（ACK/NAK）。
3. **rdt2.1**：处理ACK/NAK丢失（序列号机制）。
4. **rdt3.0**：增加超时重传，解决丢包问题。

### 3.4.3 有限状态机（FSM）示例

- **发送方状态**：
  - **等待上层调用**：接收应用数据，发送分组。
  - **等待ACK**：启动定时器，超时重传。
- **接收方状态**：
  - **等待分组0**：接收并检查序列号，发送ACK0。
  - **等待分组1**：接收并检查序列号，发送ACK1。

## 3.5 校验和机制详解

### 3.5.1 校验和计算步骤

1. **数据分块**：将数据分为16位整数序列。
2. **反码求和**：累加所有整数，溢出位回卷。
3. **取反码**：结果取反作为校验和。

**示例**：
- 数据：`0b1110011001100110` 和 `0b1101010101010101`
- 求和：`0xE666 + 0xD555 = 0x1BBBB` → 溢出后为 `0xBBBC`
- 校验和：`0x4443`（取反）

### 3.5.2 校验和局限性

- **无法检测所有错误**：如多位同时翻转可能校验和不变。
- **弱保护性**：仅用于错误检测，无法纠正错误。

## 3.6 传输层关键协议对比

| 特性         | UDP                            | TCP                            |
|--------------|--------------------------------|--------------------------------|
| **连接类型** | 无连接                         | 面向连接                       |
| **可靠性**   | 不可靠                         | 可靠（确认、重传、有序）       |
| **头部开销** | 8字节                         | 20字节（基础）                 |
| **速度**     | 快（无握手、无拥塞控制）       | 慢（连接管理、拥塞控制）       |
| **适用场景** | 实时应用、短查询               | 文件传输、Web页面加载          |

## 3.7 可靠数据传输协议（RDT）演进

### 3.7.1 RDT1.0：理想信道模型

- **假设**：信道完全可靠（无丢包、无错误）。
- **机制**：
  - 发送方直接发送数据，接收方直接接收。
  - 无错误检测、重传机制。
- **局限性**：仅适用于理论场景，无法处理实际网络问题。

### 3.7.2 RDT2.0：处理位错误

- **新增功能**：
  - **校验和（Checksum）**：检测数据错误（如16位反码和）。
  - **确认（ACK）与否定确认（NAK）**：接收方反馈是否成功接收。
  - **停等协议（Stop-and-Wait）**：发送方每发送一个包后等待确认。
- **状态机**：
  - **发送方**：等待上层数据 → 发送包 → 等待ACK/NAK。
  - **接收方**：接收包 → 检查错误 → 发送ACK/NAK。
- **问题**：ACK/NAK本身可能损坏，导致发送方无法确认状态。

### 3.7.3 RDT2.1：引入序列号

- **改进**：添加1位序列号（0或1）区分新旧包。
  - 发送方重传时携带相同序列号，接收方丢弃重复包。
- **状态机扩展**：
  - 发送方和接收方需维护当前序列号状态。
  - 处理ACK/NAK损坏时，通过序列号避免歧义。

### 3.7.4 RDT2.2：无NAK协议

- **改进**：仅使用ACK，接收方通过重复ACK（如ACK1）隐式指示错误。
  - 发送方收到重复ACK时重传数据。
- **优势**：简化协议设计，减少控制消息类型。

### 3.7.5 RDT3.0：处理丢包问题

- **新增机制**：超时重传。
  - **定时器**：发送方为每个包启动定时器，超时未收到ACK则重传。
  - **序列号扩展**：仍使用1位序列号，但通过超时机制处理丢包。
- **状态机**：
  - 发送方在等待ACK时启动定时器，超时后重传并重置定时器。
  - 接收方通过序列号过滤重复包。

## 3.8 流水线协议：提升效率

### 3.8.1 停等协议的性能瓶颈

- **信道利用率低**：发送方在RTT（往返时间）内仅发送一个包。
  - **公式**：利用率 $U = \frac{L/R}{RTT + L/R}$（$L$为包大小，$R$为链路速率）。
  - **示例**：1Gbps链路，8000bit包，RTT=30ms → 利用率仅0.027%。

### 3.8.2 回退N步（Go-Back-N, GBN）

- **核心思想**：允许发送方连续发送多个包（窗口大小N），累积确认。
- **机制**：
  - **发送方**：
    - 维护发送窗口（当前可发送的包范围）。
    - 超时重传所有未确认包（从最早未确认包开始）。
  - **接收方**：
    - 仅按序接收，丢弃乱序包。
    - 发送最高按序包的ACK（如ACK3表示0-3已接收）。
- **示例**：窗口大小N=4，丢包2时，发送方重传2、3、4、5。

### 3.8.3 选择性重传（Selective Repeat, SR）

- **核心思想**：接收方缓存乱序包，发送方仅重传丢失包。
- **机制**：
  - **发送方**：为每个包维护独立定时器，超时重传单个包。
  - **接收方**：
    - 确认所有正确接收的包（包括乱序包）。
    - 按序交付数据，窗口滑动到第一个未接收包。
- **窗口设计**：
  - **序列号空间**：窗口大小需满足 $\text{序列号范围} \geq 2 \times \text{窗口大小}$，避免歧义（如窗口3需至少7个序列号）。

## 3.9 协议对比与应用场景

| **协议** | **确认机制**       | **重传策略**         | **接收方处理**       | **适用场景**               |
|----------|--------------------|----------------------|----------------------|----------------------------|
| GBN      | 累积确认（ACK n）  | 重传所有未确认包     | 丢弃乱序包           | 低延迟网络，容忍重复开销   |
| SR       | 独立确认（每个包） | 仅重传丢失包         | 缓存乱序包           | 高带宽网络，减少重传浪费   |
| RDT3.0   | 停等确认           | 超时重传单个包       | 按序接收，无缓存     | 简单低负载环境             |

## 3.10 关键问题与解决方案

1. **ACK/NAK损坏**：
   - **RDT2.1**：引入序列号，通过重复包检测避免歧义。
2. **丢包处理**：
   - **RDT3.0**：超时重传，定时器设置需大于RTT。
3. **流水线效率**：
   - **GBN/SR**：通过窗口机制提升信道利用率，GBN适合低乱序率，SR适合高乱序率。
4. **序列号空间设计**：
   - **SR协议**：序列号范围需为窗口大小的两倍，防止新旧包混淆（如窗口3需序列号0-6）。

## 3.11 TCP协议核心机制

### 3.11.1 TCP段结构

```plaintext
 0               16              31
+----------------+----------------+
|   源端口号     |   目标端口号    |
+----------------+----------------+
|     序列号（SEQ）                |
+----------------------------------+
|     确认号（ACK）                |
+----------------+----------------+
| 首部长度 | 保留 |控制位|  窗口大小  |
+----------------+----------------+
|    校验和       |  紧急指针      |
+----------------+----------------+
|           选项（可选）           |
+----------------------------------+
|             数据载荷              |
+----------------------------------+
```
- **关键字段**：
  - **序列号（SEQ）**：数据流中第一个字节的编号（32位，循环计数）。
  - **确认号（ACK）**：期望接收的下一个字节编号（累积确认）。
  - **窗口大小（Window）**：接收方可用缓冲区大小（流量控制）。
  - **控制位**：SYN（建立连接）、ACK（确认）、FIN（终止连接）、RST（重置连接）等。

### 3.11.2 可靠数据传输机制

1. **序列号与确认机制**：
   - 每个数据字节分配唯一序列号，接收方通过ACK确认连续接收的数据。
   - **累积确认**：ACK(n)表示所有≤n的字节已正确接收。
2. **超时重传**：
   - **估计RTT**：通过指数加权移动平均（EWMA）计算：
     $$
     \text{EstimatedRTT} = (1-\alpha) \cdot \text{EstimatedRTT} + \alpha \cdot \text{SampleRTT} \quad (\alpha=0.125)
     $$
   - **超时间隔**：考虑RTT波动，加入安全边际：
     $$
     \text{TimeoutInterval} = \text{EstimatedRTT} + 4 \cdot \text{DevRTT}
     $$
3. **快速重传**：
   - 收到3个重复ACK时（如ACK=100重复3次），立即重传丢失段，无需等待超时。

## 3.12 TCP流量控制

### 3.12.1 滑动窗口机制

- **接收窗口（rwnd）**：接收方通过TCP头部通告可用缓冲区大小。
  - 发送方限制未确认数据量不超过rwnd，避免接收方溢出。
- **动态调整**：
  - 接收方根据应用读取速度更新rwnd。
  - 发送方通过ACK中的窗口字段调整发送速率。

**示例**：
- 接收方缓冲区大小为10KB，已接收5KB未读取 → rwnd=5KB。
- 发送方最多发送5KB未确认数据。

### 3.12.2 零窗口与持续计时器

- **零窗口**：接收方rwnd=0时，发送方暂停发送。
- **持续计时器**：定期发送探测段（1字节数据），避免死锁。

## 3.13 TCP连接管理

### 3.13.1 三次握手（建立连接）

1. **SYN**：客户端发送SYN段（SEQ=x，SYN=1）。
2. **SYN-ACK**：服务端回应SYN-ACK（SEQ=y，ACK=x+1，SYN=1，ACK=1）。
3. **ACK**：客户端确认（ACK=y+1，ACK=1），连接建立（ESTABLISHED）。

**状态机**：
```plaintext
客户端: CLOSED → SYN_SENT → ESTABLISHED
服务端: LISTEN → SYN_RCVD → ESTABLISHED
```

### 3.13.2 四次挥手（终止连接）

1. **FIN**：主动关闭方发送FIN段（FIN=1）。
2. **ACK**：接收方确认FIN。
3. **FIN**：接收方发送FIN段。
4. **ACK**：主动关闭方确认，进入TIME_WAIT（等待2MSL防止旧报文干扰）。

**状态机**：
```plaintext
主动方: ESTABLISHED → FIN_WAIT_1 → FIN_WAIT_2 → TIME_WAIT → CLOSED
被动方: ESTABLISHED → CLOSE_WAIT → LAST_ACK → CLOSED
```

## 3.14 TCP拥塞控制

### 3.14.1 拥塞控制原理

- **目标**：避免网络过载，平衡吞吐量与延迟。
- **与流量控制的区别**：

| **特性**       | **拥塞控制**               | **流量控制**               |
|----------------|----------------------------|----------------------------|
| 控制对象        | 网络全局资源                | 接收方缓冲区               |
| 触发条件        | 丢包、延迟增加              | 接收方窗口减少             |
| 实现机制        | AIMD、慢启动等              | 滑动窗口、零窗口探测        |

### 3.14.2 核心算法

1. **慢启动（Slow Start）**：
   - 初始cwnd=1 MSS，每RTT翻倍（指数增长）。
   - 触发切换：cwnd≥ssthresh时进入拥塞避免阶段。
2. **拥塞避免（AIMD）**：
   - 每RTT增加1 MSS（线性增长）。
   - 丢包时，ssthresh=cwnd/2，cwnd=1 MSS（超时）或cwnd=ssthresh（快速恢复）。
3. **快速恢复**：
   - 收到3个重复ACK时，cwnd=ssthresh+3，重传丢失段。

**拥塞控制状态机**：
```plaintext
慢启动 → (cwnd≥ssthresh) → 拥塞避免
丢包（超时）→ 慢启动
丢包（3 DupACK）→ 快速恢复 → 拥塞避免
```

## 3.15 高级主题与协议演进

### 3.15.1 显式拥塞通知（ECN）

- **机制**：路由器标记IP头部ECN位，接收方通过TCP ACK反馈拥塞。
  - ECN=11（拥塞经历），ECE=1（ECN-Echo）。
- **优势**：提前预警，避免丢包导致的吞吐量骤降。

### 3.15.2 QUIC协议

- **基于UDP**：解决TCP队头阻塞（HOL Blocking），支持多独立流。
- **特性**：
  - 0-RTT连接建立（复用先前会话密钥）。
  - 内置加密（TLS 1.3），头部保护。
  - 前向纠错（FEC）减少重传。
- **应用**：HTTP/3标准，优化Web性能。

## 3.16 关键公式与性能指标

1. **吞吐量公式**：
   $$
   \text{Throughput} \approx \frac{\text{cwnd}}{\text{RTT}}
   $$
2. **理想拥塞控制吞吐量**（Mathis公式）：
   $$
   \text{Throughput} = \frac{1.22 \cdot \text{MSS}}{\text{RTT} \cdot \sqrt{L}} \quad (L=\text{丢包率})
   $$

## 附录

### 关键术语速查表

| **术语**         | **定义**                                                                 |
|------------------|-------------------------------------------------------------------------|
| 累积确认（ACK n）| 表示所有≤n的包已正确接收                                               |
| 选择确认（SACK） | 显式确认非连续接收的包（需扩展协议支持）                                |
| 滑动窗口         | 动态调整发送/接收窗口范围，平衡吞吐量与资源占用                         |
| 超时重传         | 定时器触发后重传未确认包，解决丢包问题                                  |
| 多路复用           | 合并多个数据流到单一网络层通道                                       |
| 分解               | 将接收的数据分发到目标应用进程                                       |
| 校验和             | 用于检测数据传输错误的计算值                                         |
| 有限状态机（FSM） | 描述协议状态转换的模型，包含状态、事件、动作                         |

### 常见问题解答

#### 1. 如何区分流量控制与拥塞控制？

| **特征**         | **流量控制**                     | **拥塞控制**                     |
|------------------|----------------------------------|----------------------------------|
| **目标**         | 防止接收方缓冲区溢出             | 防止网络过载                     |
| **触发条件**     | 接收方窗口（rwnd）不足           | 丢包、延迟增加                   |
| **控制对象**     | 点对点（发送方与接收方）          | 全局网络资源                     |
| **实现机制**     | 滑动窗口动态调整发送速率          | AIMD算法（慢启动、拥塞避免等）   |
| **调整参数**     | 接收方通告的rwnd                 | 发送方维护的cwnd                 |

#### 2. 快速重传为何设置为3个重复ACK？

- **避免误判**：网络可能存在包乱序（如路径不同），少量重复ACK（如1-2个）可能是乱序而非丢包。
- **平衡效率**：3次重复ACK是经验值，既减少误判概率，又避免过晚触发重传。
- **RFC标准**：TCP协议规定3个重复ACK作为丢包标志，触发快速重传。

#### 3. QUIC相比TCP的优势有哪些？

| **优势**         | **QUIC**                          | **TCP**                          |
|------------------|------------------------------------|----------------------------------|
| **传输层协议**   | 基于UDP，绕过中间设备限制          | 基于IP，易受NAT/防火墙限制        |
| **队头阻塞**     | 多路复用独立流，无队头阻塞         | 单流，队头阻塞影响性能           |
| **连接建立**     | 0-RTT/1-RTT握手（复用先前会话）    | 3次握手（至少1-RTT）             |
| **加密**         | 内置TLS 1.3，强制加密              | 可选TLS，需额外握手               |
| **拥塞控制**     | 灵活，支持多种算法（如BBR）        | 固定AIMD，调整不灵活             |
| **移动网络优化** | 连接迁移（IP变化不影响会话）       | 依赖IP，切换网络需重建连接        |
